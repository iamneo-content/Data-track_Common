-- =====================================================================
-- PRACTICE QUESTION:
-- UNSORTED VS. SORTED LOAD IN REDSHIFT
-- =====================================================================
-- Objective:
--  Demonstrate how inserting unsorted data affects SORTKEY order
--  and how VACUUM SORT ONLY restores order.
-- =====================================================================

-- =====================================================================
-- STEP 1: Drop existing table (if re-run)
-- =====================================================================
DROP TABLE IF EXISTS orders_sorted;

-- =====================================================================
-- STEP 2: Create a sorted table
-- =====================================================================
CREATE TABLE orders_sorted (
    order_id INT,
    customer_id INT,
    order_date DATE,
    amount NUMERIC(10,2)
)
SORTKEY (order_date);

-- =====================================================================
-- STEP 3: Insert 30 rows in sorted order (Jan 1–30)
-- =====================================================================
INSERT INTO orders_sorted VALUES
(1, 101, '2024-01-01', 250.50),
(2, 102, '2024-01-02', 300.00),
(3, 103, '2024-01-03', 150.75),
(4, 104, '2024-01-04', 420.00),
(5, 105, '2024-01-05', 180.20),
(6, 106, '2024-01-06', 500.00),
(7, 107, '2024-01-07', 295.30),
(8, 108, '2024-01-08', 410.10),
(9, 109, '2024-01-09', 390.40),
(10, 110, '2024-01-10', 210.75),
(11, 111, '2024-01-11', 350.00),
(12, 112, '2024-01-12', 480.50),
(13, 113, '2024-01-13', 260.25),
(14, 114, '2024-01-14', 390.00),
(15, 115, '2024-01-15', 275.40),
(16, 116, '2024-01-16', 320.60),
(17, 117, '2024-01-17', 500.75),
(18, 118, '2024-01-18', 450.00),
(19, 119, '2024-01-19', 310.25),
(20, 120, '2024-01-20', 280.40),
(21, 121, '2024-01-21', 340.60),
(22, 122, '2024-01-22', 420.10),
(23, 123, '2024-01-23', 460.80),
(24, 124, '2024-01-24', 255.20),
(25, 125, '2024-01-25', 510.00),
(26, 126, '2024-01-26', 280.30),
(27, 127, '2024-01-27', 305.10),
(28, 128, '2024-01-28', 495.75),
(29, 129, '2024-01-29', 385.25),
(30, 130, '2024-01-30', 410.90);

-- =====================================================================
-- STEP 4: Check initial sort state (unsorted should be 0%)
-- =====================================================================
SELECT "table", size, unsorted
FROM svv_table_info
WHERE "table" = 'orders_sorted';

-- =====================================================================
-- STEP 5: Insert 20 rows unsorted (mixed dates)
-- =====================================================================
INSERT INTO orders_sorted VALUES
(31, 131, '2024-01-05', 255.00),
(32, 132, '2024-01-10', 375.00),
(33, 133, '2024-01-03', 285.00),
(34, 134, '2024-01-08', 465.00),
(35, 135, '2024-01-02', 490.00),
(36, 136, '2024-01-12', 310.00),
(37, 137, '2024-01-01', 150.00),
(38, 138, '2024-01-15', 305.00),
(39, 139, '2024-01-09', 230.00),
(40, 140, '2024-01-20', 390.00),
(41, 141, '2024-01-04', 210.00),
(42, 142, '2024-01-06', 460.00),
(43, 143, '2024-01-17', 270.00),
(44, 144, '2024-01-19', 320.00),
(45, 145, '2024-01-23', 355.00),
(46, 146, '2024-01-07', 290.00),
(47, 147, '2024-01-11', 425.00),
(48, 148, '2024-01-13', 285.00),
(49, 149, '2024-01-25', 410.00),
(50, 150, '2024-01-18', 260.00);

-- =====================================================================
-- STEP 6: Check unsorted percentage before VACUUM
-- =====================================================================
SELECT "table", size, unsorted
FROM svv_table_info
WHERE "table" = 'orders_sorted';

-- Expected: unsorted value between 30–60%

-- =====================================================================
-- STEP 7: Run VACUUM SORT ONLY to restore sort order
-- =====================================================================
VACUUM SORT ONLY orders_sorted;

-- =====================================================================
-- STEP 8: Check unsorted percentage after VACUUM
-- =====================================================================
SELECT "table", size, unsorted
FROM svv_table_info
WHERE "table" = 'orders_sorted';

-- Expected: unsorted = 0%

-- =====================================================================
-- STEP 9: Verify rows are now in correct sort order
-- =====================================================================
SELECT order_id, order_date, amount
FROM orders_sorted
ORDER BY order_date
LIMIT 20;

